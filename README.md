# hotspot-detection
Here we provide the code for the methodology of our paper "A novel method for subgroup discovery in precision medicine based on topological data analysis" (Loughrey, C.F., Maguire, S., Dlotko, P., Bai, L., Orr, N., Jurek-Loughrey, A.). The code was implemented by the first author: C. Loughrey.

This repository contains hot-mapper, the general implementation of hotspot detection on the TDA tool Mapper for applications in bioinformatics. Mapper builds network graphs from a dataset through a combination of clustering and dimensionality reduction. Hotspot detection identifies anomalous interconnected groups of nodes in the graph. In biomedical terms, these hotspots can represent unusual patients subtypes.


# Data
The datasets used are found at the following links:
•	METABRIC: raw gene expression data in IDAT format. European Genome-Phenome Archive, Dataset ID EGAD00010000162 (https://ega-archive.org/datasets/)
•	TCGA: raw fastq files. National Cancer Institute Genomic Data Commons Data Portal legacy archive, TCGA project access number 16762 (https://portal.gdc.cancer.gov/legacy-archive/search/f)
•	GTEX: raw gene read counts. Genotype-Tissue Expression Project, 'GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct.gz' (https://gtexportal.org/home/datasets)

# Code

### Step 1: Data pre-processing (BC-01-match_genes_in_datasets.py)
This script prepares the gene expression datasets for input into the DSGA method. Missing data is handled for GTEX by removing genes and imputing using KNN for TCGA. 

For each breast cancer cohort, a pair of dataframes is created by matching the gene features in the tumour dataset to those in the GTEX dataset. 

Input
- data/metabric_protein_coding_genes_expression_zscore.csv (18,930 genes; 1,429 breast tumour samples)
- data/tcga_protein_coding_genes_expression_zscore.csv (19,957 genes; 790 breast tumour samples)
- data/gtex_protein_coding_genes_expression_zscore.csv (36,043 genes; 168 breast tumour samples)

Output
- processed_data/metabric_tumour_matched.csv (17,903 genes; 1,429 breast tumour samples)
- processed_data/metabric_normal_matched.csv (17,903 genes; 168 healthy breast tissue samples)
- processed_data/tcga_tumour_matched.csv (18,406 genes; 790 breast tumour  samples)
- processed_data/tcga_normal_matched.csv (18,406 genes; 168 healthy breast tissue samples)

### Step 2: Disease Specific Genomic Analysis (BC-02-DSGA.py)
This script performs Disease Specific Genomic Analysis (DSGA) on both tumour datasets independently. The disease component of diseased tissue data is estimated by comparison by a healthy state model. In our analysis, the GTEX data is used to build the healthy state model.

For the METABRIC data, a gene threshold is used when performing DSGA. The output is a transformed dataset representing the disease component (DcT) of the tumour samples for 575 genes with a significant deviation from the healthy data. 

For the TCGA data, a gene threshold is not used when performing DSGA. The genes in the TCGA DcT are restricted to those found in the METABRIC DcT. 

Input
- processed_data/metabric_tumour_matched.csv (17,903 genes; 1,429 breast tumour samples)
- processed_data/metabric_normal_matched.csv (17,903 genes; 168 healthy breast tissue samples)
- processed_data/tcga_tumour_matched.csv (18,406 genes; 790 breast tumour  samples)
- processed_data/tcga_normal_matched.csv (18,406 genes; 168 healthy breast tissue samples)

Output
- processed_data/metabric_dct.csv (575 genes; 1,429 breast tumour samples)
- processed_data/tcga_dct.csv (575 genes; 790 breast tumour samples)

### Step 3: Select survival information from clinical data (BC-03-clean-clinical-survival.R)

This script selects which type of survival information (e.g. overall survival or relapse free survival) will be used for this analysis from the clinical dataset.

Input 
- data/metabric_clinical_erpos_cbioportal.csv
- data/tcga_clinical_erpos_cbioportal.csv

Output
- processed_data/metabric_survival.csv
- processed_data/tcga_survival.csv

### Step 4: Search for hotspots in discovery dataset (BC-04-discovery-hotspot-search.py)

This script generates a lens function and creates a Mapper graph for each specific parameter combination on the METABRIC discovery dataset. These graphs are searched for hotspots, and survival analysis is performed between the hotspot group and the neighbourhood. If the logrank p-value < 0.01, the search is considered successful and ends. 

For all hotspots in a single lens function that can be generated by multiple interval and overlap combinations, these hotspots are ranked by p-value and the hotspot with the lowest p-value is accepted as the final parameter selection.


The accepted graph parameters from the hotspot search are saved in 'outputs/hotspot_search/discovery/" directory, but the succesful parameters identified for the paper are saved in 'outputs/hotspot_search/discovery_final_results/" to prevent overwriting. 


Input
- processed_data/metabric_dct.csv (575 genes; 1,429 breast tumour samples)
- processed_data/metabric_survival.csv

Output

- hotspot_search/discovery/metabric__hotspot_dataframe.csv
- hotspot_search/discovery/metabric_parameters.txt
- hotspot_search/discovery/metabric_weights.txt
- hotspot_search/discovery/metabric_feature_list.txt


### Step 5: Build Mapper graph from discovery search (BC-05-discovery-mapper-graph.py)

This script uses the successful parameters identified through the hotspot search of the METABRIC discovery cohort. It builds the graph to visualise the output and annotates the nodes that have been identified as hotspots. It also appends hotspot labels to the METABRIC sample IDs and their corresponding survival information. 

To recreate the mapper graph from the paper, we are using an input directory of 'outputs/hotspot_search/discovery_final_results/" for the mapper graph parameter settings. Change this to 'outputs/hotspot_search/discovery/" directory if you want to see the output from a new hotspot search on the discovery group. 


Input
- processed_data/metabric_dct.csv
- processed_data/metabric_survival.csv
- hotspot_search/discovery_final_results/metabric_parameters.txt
- hotspot_search/discovery_final_results/metabric_weights.txt
- hotspot_search/discovery_final_results/metabric_feature_list.txt

Output
- mapper_graphs/metabric_mapper_survival_labelled.png
- mapper_graphs/metabric_mapper_survival_hotspots_unlabelled.png
- processed_data/metabric_hotspot_id_survival.csv

### Step 6: Survival analysis  (BC-06-discovery-survival.R)

Perform survival analysis on METABRIC hotspot group and plot Kaplan-Meier graph. 

Kaplan-Meier plot needs to be manually saved due to issues with 'survminer' package


Input
- processed_data/metabric_hotspot_id_survival.csv"

Output
- survival_analysis/metabric_km_plot.svg


### Step 7: Investigating clinical features of discovery hotspot (BC-07-investigating-discovery-clinical-features.R)

In this script Chi-Squared tests are performed to test the associations between clinical categorical features and the hotspot group. Outputs are saved in "clinical_feature_investigation". The output contains sheets of the group contigency tables and chi2 results are in the "CHISQ" sheet at the end. 

Input
- data/metabric_clinical_historic_version.csv
- processed_data/metabric_hotspot_id_survival.csv"

Output
- clinical_feature_investigation/clinical_features_contingency_tables.xlsx
- clinical_feature_investigation/ERROR_clinical_features_historic.xlsx


### Step 8: Hotspots validation dataset  (BC-08-validation-hotspot-search.py)

This script uses the successful lens function identified through the hotspot search of the METABRIC discovery cohort, and searches for hotspots in the TCGA validation cohort across interval and overlap parameters. Graphs are generated for each parameter combination, these graphs are searched for hotspots, and survival analysis is performed between the hotspot group and the neighbourhood. 

The accepted graph parameters from the hotspot search are saved in 'outputs/hotspot_search/validation/" directory, but the succesful parameters identified for the paper are saved in 'outputs/hotspot_search/validaton_final_results/" to prevent overwriting. 


Input
- processed_data/tcga_dct.csv (575 genes; 1,429 breast tumour samples)
- processed_data/tcga_survival.csv
- hotspot_search/discovery/metabric_weights.txt
- hotspot_search/discovery/metabric_feature_list.txt

Output
- hotspot_search/validation/tcga_hotspot_dataframe.csv
- hotspot_search/validation/tcga_parameters.txt
- hotspot_search/validation/tcga_weights.txt
- hotspot_search/validation/tcga_feature_list.txt


### Step 9: Validation Mapper graph  (BC-09-validation-mapper-graph.py)

This script uses the successful lens function identified from the METABRIC discovery hotspot search and the interval and overlap parameters identified from the TCGA validation hotspot search. It builds the graph of the TCGA dataset to visualise the output and annotates the nodes that have been identified as hotspots. It also appends hotspot labels to the TCGA sample IDs and their corresponding survival information. A second Mapper graph is labelled according to the distance of nodes from the TCGA Mapper graph to the centroid of the METABRIC hotspot group. 

To recreate the mapper graph from the paper, we are using an input directory of 'outputs/hotspot_search/validation_final_results/" for the mapper graph parameter settings. Change this to 'outputs/hotspot_search/validation/" directory if you want to see the output from a new hotspot search on the validation group. 


Input
- processed_data/tcga_dct.csv
- processed_data/tcga_survival.csv
- hotspot_search/validation_final_results/tcga_parameters.txt
- hotspot_search/validation_final_results/tcga_weights.txt
- hotspot_search/validation_final_results/tcga_feature_list.txt
- processed_data/metabric_dct.csv
- processed_data/metabric_hotspot_id_survival.csv

Output
- mapper_graphs/tcga_mapper_survival_labelled.png
- mapper_graphs/tcga_mapper_survival_hotspots_unlabelled.png
- mapper_graphs/tcga_mapper_centroid_labelled.png
- mapper_graphs/tcga_mapper_closest_centroid_unlabelled.png
- processed_data/tcga_hotspot_id_survival.csv

